import{n as f,a as b,r as g,o as q,u as h,s as l}from"./index.86e6aef6.js";import{c as w}from"./ServicesServices.fb4cee89.js";const x={name:"ShoppingCart",setup(){const s=b({products:[],total:0}),t=g(""),r=()=>{s.total=s.products.reduce((o,a)=>o+a.product.price*a.quantity,0)},e=async()=>{try{const o=await window.dbCarrito.allDocs({include_docs:!0});s.products=o.rows.map(a=>({product:a.doc,quantity:a.doc.quantity||1})),r()}catch(o){console.error("Error al cargar el carrito:",o)}},u=async o=>{const a=s.products.find(n=>n.product._id===o);a&&(a.quantity+=1,a.product.quantity=a.quantity,await window.dbCarrito.put(a.product),r())},c=async o=>{const a=s.products.find(n=>n.product._id===o);a&&a.quantity>1?(a.quantity-=1,a.product.quantity=a.quantity,await window.dbCarrito.put(a.product),r()):a&&await _(o)},_=async o=>{const a=s.products.findIndex(n=>n.product._id===o);a!==-1&&(await window.dbCarrito.remove(s.products[a].product),s.products.splice(a,1),r())},p=async()=>{try{const a=(await window.dbCarrito.allDocs()).rows.map(n=>window.dbCarrito.remove(n.id,n.value.rev));await Promise.all(a),s.products=[],r()}catch(o){console.error("Error al vaciar el carrito:",o)}},C=async()=>{const{user:o}=h();if(!!!(o!=null&&o.token)){l("warning","Inicia sesi\xF3n para proceder con tu compra.");return}if(s.products.length===0){l("warning","El carrito est\xE1 vac\xEDo.");return}const n={products:s.products.map(i=>({product:{uid:i.product._id},quantity:i.quantity})),status:"EXIT",observations:t.value};try{await w(n)?await p():(await m(n),l("warning","Sin conexi\xF3n. La orden se guardar\xE1 para env\xEDo posterior."),p())}catch(i){console.error("Error en comprarCart:",i),await m(n),l("error","Error al procesar la compra. Intenta de nuevo.")}},m=async o=>{try{const a={_id:new Date().toISOString(),payload:o,sent:!1};await window.dbComprarCarrito.put(a),await window.dbMovimientos.put({...o,_id:a._id})}catch(a){console.error("Error al guardar la orden offline:",a)}};let v=!1;const y=async()=>{if(!v){v=!0;try{const a=(await window.dbComprarCarrito.allDocs({include_docs:!0})).rows.filter(n=>!n.doc.sent&&!n.doc.sending);for(const n of a)try{n.doc.sending=!0,await window.dbComprarCarrito.put(n.doc),await w(n.doc.payload)&&(await window.dbComprarCarrito.remove(n.doc._id,n.doc._rev),console.log("Orden enviada y eliminada correctamente:",n.doc._id))}catch(i){console.error("Error al procesar la orden:",i,"ID:",n.doc._id)}}catch(o){console.error("Error al procesar \xF3rdenes pendientes:",o)}finally{v=!1}}},d=async()=>{navigator.onLine&&await y()};return q(()=>{e(),d(),window.removeEventListener("online",d),window.addEventListener("online",d)}),window.addEventListener("online",d),{cart:s,observations:t,incrementQuantity:u,decrementQuantity:c,removeProduct:_,clearCart:p,comprarCart:C}}};var E=function(){var t=this,r=t._self._c;return r("div",{staticClass:"shopping-cart"},[r("h1",{staticClass:"text-2xl text-center font-bold text-gray-800 mb-6"},[t._v(" Carrito de Compras ")]),t.cart.products.length===0?r("div",{staticClass:"empty-cart"},[r("p",[t._v("El carrito est\xE1 vac\xEDo.")])]):r("div",{staticClass:"cart-items"},[r("ul",t._l(t.cart.products,function(e,u){return r("li",{key:u,staticClass:"cart-item"},[r("div",{staticClass:"item-info"},[r("div",{staticClass:"product-name"},[r("h3",[t._v(t._s(e.product.name))]),r("p",[t._v("Proveedor: "+t._s(e.product.provider))])]),r("p",[t._v("Cantidad: "+t._s(e.quantity))]),r("p",[t._v("Precio: $"+t._s((e.product.price||0).toFixed(2)))]),r("p",[t._v(t._s(e.product.description))])]),r("div",{staticClass:"item-actions"},[r("div",{staticClass:"qr-code"},[r("img",{attrs:{src:e.product.qrCode,alt:"QR Code"}})]),r("div",{staticClass:"quantity-actions"},[r("button",{staticClass:"quantity-btn custom-btn",on:{click:function(c){return t.incrementQuantity(e.product._id)}}},[t._v(" + ")]),r("span",{staticClass:"quantity-display"},[t._v(t._s(e.quantity))]),r("button",{staticClass:"quantity-btn custom-btn",on:{click:function(c){return t.decrementQuantity(e.product._id)}}},[t._v(" - ")])]),r("button",{staticClass:"remove-btn custom-btn",on:{click:function(c){return t.removeProduct(e.product._id)}}},[t._v(" Eliminar ")])])])}),0)]),r("div",{staticClass:"cart-total"},[r("p",[t._v("Total: $"+t._s(t.cart.total.toFixed(2)))])]),t.cart.products.length>0?r("div",{staticClass:"observations-section"},[r("label",{staticClass:"text-lg font-semibold text-gray-700",attrs:{for:"observations"}},[t._v("Observaciones:")]),r("textarea",{directives:[{name:"model",rawName:"v-model",value:t.observations,expression:"observations"}],staticClass:"observations-textarea",attrs:{id:"observations",rows:"4",placeholder:"Puedes escribir referencias, instrucciones o comentarios adicionales aqu\xED."},domProps:{value:t.observations},on:{input:function(e){e.target.composing||(t.observations=e.target.value)}}})]):t._e(),r("div",{staticClass:"quantity-actions"},[r("button",{staticClass:"clear-cart-btn custom-btn",on:{click:t.clearCart}},[t._v("Vaciar carrito")]),r("br"),r("button",{staticClass:"comprar-cart-btn custom-btn",on:{click:t.comprarCart}},[t._v("Comprar")])])])},O=[],S=f(x,E,O,!1,null,"956a46a8",null,null);const P=S.exports;export{P as default};
