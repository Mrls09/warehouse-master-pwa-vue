import{n as y,a as f,o as b,u as g,s as l}from"./index.83e961e9.js";import{c as _}from"./ServicesServices.cf382ef1.js";const q={name:"ShoppingCart",setup(){const s=f({products:[],total:0}),t=()=>{s.total=s.products.reduce((a,o)=>a+o.product.price*o.quantity,0)},r=async()=>{try{const a=await window.dbCarrito.allDocs({include_docs:!0});s.products=a.rows.map(o=>({product:o.doc,quantity:o.doc.quantity||1})),t()}catch(a){console.error("Error al cargar el carrito:",a)}},e=async a=>{const o=s.products.find(n=>n.product._id===a);o&&(o.quantity+=1,o.product.quantity=o.quantity,await window.dbCarrito.put(o.product),t())},u=async a=>{const o=s.products.find(n=>n.product._id===a);o&&o.quantity>1?(o.quantity-=1,o.product.quantity=o.quantity,await window.dbCarrito.put(o.product),t()):o&&await i(a)},i=async a=>{const o=s.products.findIndex(n=>n.product._id===a);o!==-1&&(await window.dbCarrito.remove(s.products[o].product),s.products.splice(o,1),t())},p=async()=>{try{const o=(await window.dbCarrito.allDocs()).rows.map(n=>window.dbCarrito.remove(n.id,n.value.rev));await Promise.all(o),s.products=[],t()}catch(a){console.error("Error al vaciar el carrito:",a)}},m=async()=>{const{user:a}=g();if(!!!(a!=null&&a.token)){l("warning","Inicia sesi\xF3n para proceder con tu compra.");return}if(s.products.length===0){l("warning","El carrito est\xE1 vac\xEDo.");return}const n={products:s.products.map(c=>({product:{uid:c.product._id},quantity:c.quantity})),status:"EXIT",observations:observations.value};try{await _(n)?await p():(await C(n),l("warning","Sin conexi\xF3n. La orden se guardar\xE1 para env\xEDo posterior."),p())}catch(c){console.error("Error en comprarCart:",c),l("error","Error al procesar la compra. Intenta de nuevo.")}},C=async a=>{try{const o={_id:new Date().toISOString(),payload:a,sent:!1};await window.dbComprarCarrito.put(o)}catch(o){console.error("Error al guardar la orden offline:",o)}};let v=!1;const w=async()=>{if(!v){v=!0;try{const o=(await window.dbComprarCarrito.allDocs({include_docs:!0})).rows.filter(n=>!n.doc.sent&&!n.doc.sending);for(const n of o)try{n.doc.sending=!0,await window.dbComprarCarrito.put(n.doc),await _(n.doc.payload)&&(await window.dbComprarCarrito.remove(n.doc._id,n.doc._rev),console.log("Orden enviada y eliminada correctamente:",n.doc._id))}catch(c){console.error("Error al procesar la orden:",c,"ID:",n.doc._id)}}catch(a){console.error("Error al procesar \xF3rdenes pendientes:",a)}finally{v=!1}}},d=async()=>{navigator.onLine&&await w()};return b(()=>{r(),d(),window.removeEventListener("online",d),window.addEventListener("online",d)}),window.addEventListener("online",d),{cart:s,incrementQuantity:e,decrementQuantity:u,removeProduct:i,clearCart:p,comprarCart:m}}};var h=function(){var t=this,r=t._self._c;return r("div",{staticClass:"shopping-cart"},[r("h1",{staticClass:"text-2xl text-center font-bold text-gray-800 mb-6"},[t._v(" Carrito de Compras ")]),t.cart.products.length===0?r("div",{staticClass:"empty-cart"},[r("p",[t._v("El carrito est\xE1 vac\xEDo.")])]):r("div",{staticClass:"cart-items"},[r("ul",t._l(t.cart.products,function(e,u){return r("li",{key:u,staticClass:"cart-item"},[r("div",{staticClass:"item-info"},[r("div",{staticClass:"product-name"},[r("h3",[t._v(t._s(e.product.name))]),r("p",[t._v("Proveedor: "+t._s(e.product.provider))])]),r("p",[t._v("Cantidad: "+t._s(e.quantity))]),r("p",[t._v("Precio: $"+t._s((e.product.price||0).toFixed(2)))]),r("p",[t._v(t._s(e.product.description))])]),r("div",{staticClass:"item-actions"},[r("div",{staticClass:"qr-code"},[r("img",{attrs:{src:e.product.qrCode,alt:"QR Code"}})]),r("div",{staticClass:"quantity-actions"},[r("button",{staticClass:"quantity-btn custom-btn",on:{click:function(i){return t.incrementQuantity(e.product._id)}}},[t._v(" + ")]),r("span",{staticClass:"quantity-display"},[t._v(t._s(e.quantity))]),r("button",{staticClass:"quantity-btn custom-btn",on:{click:function(i){return t.decrementQuantity(e.product._id)}}},[t._v(" - ")])]),r("button",{staticClass:"remove-btn custom-btn",on:{click:function(i){return t.removeProduct(e.product._id)}}},[t._v(" Eliminar ")])])])}),0)]),r("div",{staticClass:"cart-total"},[r("p",[t._v("Total: $"+t._s(t.cart.total.toFixed(2)))])]),t.cart.products.length>0?r("div",{staticClass:"observations-section"},[r("label",{staticClass:"text-lg font-semibold text-gray-700",attrs:{for:"observations"}},[t._v("Observaciones:")]),r("textarea",{directives:[{name:"model",rawName:"v-model",value:t.observations,expression:"observations"}],staticClass:"observations-textarea",attrs:{id:"observations",rows:"4",placeholder:"Puedes escribir referencias, instrucciones o comentarios adicionales aqu\xED."},domProps:{value:t.observations},on:{input:function(e){e.target.composing||(t.observations=e.target.value)}}})]):t._e(),r("div",{staticClass:"quantity-actions"},[r("button",{staticClass:"clear-cart-btn custom-btn",on:{click:t.clearCart}},[t._v("Vaciar carrito")]),r("br"),r("button",{staticClass:"comprar-cart-btn custom-btn",on:{click:t.comprarCart}},[t._v("Comprar")])])])},x=[],E=y(q,h,x,!1,null,"c25961b8",null,null);const k=E.exports;export{k as default};
